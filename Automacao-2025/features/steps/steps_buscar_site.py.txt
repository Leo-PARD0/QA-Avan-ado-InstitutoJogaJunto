
#5Ô∏è‚É£6Ô∏è‚É£7Ô∏è‚É£8Ô∏è‚É£9Ô∏è‚É£üîü
# ============================================================
# üß© Importa√ß√£o das bibliotecas necess√°rias
# ============================================================

from behave import given, when, then  
# Importa as anota√ß√µes (decorators) do framework Behave, que s√£o usadas para
# definir etapas do comportamento BDD:
# @given ‚Üí representa o "Dado que"
# @when  ‚Üí representa o "Quando"
# @then  ‚Üí representa o "Ent√£o"
# Elas conectam o texto escrito no arquivo .feature com o c√≥digo que o executa.

from selenium.webdriver import Edge  
# Importa o driver do navegador Microsoft Edge, usado pelo Selenium para controlar o navegador.

from selenium.webdriver.edge.options import Options  
# Importa a classe Options, que permite configurar par√¢metros do navegador (como tela cheia, logs, etc).

from selenium.webdriver.common.by import By  
# Classe que define os diferentes tipos de seletores (estrat√©gias para localizar elementos na p√°gina),
# como: By.ID, By.NAME, By.XPATH, By.CSS_SELECTOR, etc.

from selenium.webdriver.common.keys import Keys  
# Permite simular o uso de teclas do teclado, como ENTER, TAB, SETA, etc.

from selenium.webdriver.support.ui import WebDriverWait

import time  
# Biblioteca padr√£o do Python usada aqui para adicionar pausas (delays) entre as a√ß√µes.
# Isso garante que a p√°gina tenha tempo de carregar antes do pr√≥ximo comando.

# ============================================================
# üß† Defini√ß√£o dos passos do teste BDD (Gherkin)
# ============================================================

# ----------------------------------------
# 1Ô∏è‚É£ Etapa "DADO QUE..."
# ----------------------------------------
@given("que o navegador Microsoft Edge est√° aberto")
def step_open_browser(context):
    # Cria um objeto de configura√ß√£o do navegador
    options = Options()

    # Inicia o navegador maximizado (em tela cheia)
    options.add_argument("--start-maximized")

    # Desativa a detec√ß√£o de automa√ß√£o (impede que sites saibam que o navegador √© controlado por Selenium)
    options.add_argument("--disable-blink-features=AutomationControlled")

    # Remove mensagens de log desnecess√°rias no terminal (de "DevTools" e "EdgeAuth")
    options.add_experimental_option("excludeSwitches", ["enable-logging"])

    # Inicializa o navegador Edge com as op√ß√µes definidas acima
    context.driver = Edge(options=options)

    # Abre o site inicial: Google
    context.driver.get("https://www.google.com")

    # Aguarda 3 segundos para garantir que a p√°gina carregue
    time.sleep(3)


# ----------------------------------------
# 2Ô∏è‚É£ Etapa "QUANDO..."
# ----------------------------------------
@when('eu pesquisar por "WhatsApp Web" no Google')
def step_search_google(context):
    # Localiza o campo de busca do Google pelo atributo NAME="q"
    campo = context.driver.find_element(By.NAME, "q")

    # Digita o texto "Instituto Joga Junto" no campo de pesquisa
    campo.send_keys("WhatsApp Web")

    # Pressiona a tecla ENTER para executar a busca
    campo.send_keys(Keys.RETURN)

    # Espera 4 segundos at√© os resultados aparecerem
    time.sleep(4)


# ----------------------------------------
# 3Ô∏è‚É£ Etapa "ENT√ÉO..."
# ----------------------------------------
@then("devo ver o site do WhatsApp aberto com sucesso")
def step_verify_site(context):
    # Captura todos os elementos que representam t√≠tulos de resultados (tags <h3>)
    resultados = context.driver.find_elements(By.CSS_SELECTOR, "h3")

    # Verifica se h√° pelo menos um resultado de busca
    if resultados:
        # Clica no primeiro resultado (simula o clique do usu√°rio)
        resultados[0].click()

        # Aguarda 5 segundos para o site abrir completamente
        time.sleep(5)

        # Verifica se a URL cont√©m o termo "jogajunto"
        # Essa verifica√ß√£o confirma que o site do Instituto realmente foi acessado.
        assert "web.whatsapp" in context.driver.current_url.lower()

        # Exibe uma mensagem de sucesso no terminal
        print("üåê Site do WhatsApp Web aberto com sucesso!")
    else:
        # Caso nenhum resultado tenha sido encontrado, lan√ßa um erro de teste
        raise AssertionError("‚ùå Nenhum resultado encontrado.")
    
# ----------------------------------------
# 4Ô∏è‚É£ Etapa "Verifica whtastapp"
# ----------------------------------------

@given("que estou na p√°gina do WhatsApp")
def step_verify_whtastapp(context):
    # gerar uma vari√°vel para armazenar a url
    if hasattr(context, 'driver'): # se tem o atributo (has attribute) driver no contexto (se o objeto contexto tem o navegador)
        url = context.driver.current_url.lower() # url ser√° a url atual
    else:
        url = "" # caso n√£o tenha, a url ser√° vazia
    # verificar se a url √© a certa
    if 'web.whatsapp' not in url: # caso a url n√£o seja a do whtasapp
        context.driver.get("https://web.whatsapp.com") # ir√° pesquisar diretamente pela do whatsapp
    
    input("Pressione enter para prosseguir...")

    time.sleep(15) # aguarda 15 segundos para o site abrir completamente

    print("üåê Site do WhatsApp Web aberto com sucesso!")
    
@when('eu logar com QR code')
def wait_login(context):
    """
    Aqui o script aguarda o usu√°rio escanear o QR (a√ß√£o manual).
    Timeout padr√£o: 180 segundos ‚Äî ajuste conforme sua necessidade.
    """
    print("üì± Por favor, escaneie o QR code com seu celular para fazer login no WhatsApp Web.")

    """ 
    # tira screenshot do QR (opcional, √∫til para evid√™ncia)
    try:
        context.driver.save_screenshot("evidence_qr.png")
        print("üì∏ Screenshot do QR salva: evidence_qr.png")
    except Exception:
        print("‚ö†Ô∏è N√£o foi poss√≠vel salvar screenshot do QR (ignorando).")
    """

    verificadores_login = 'div[contenteditable="true"][data-tab]'

    timeout_total = 180
    inicio = time.time()


    while time.time() - inicio< timeout_total:
        if context.driver.find_element(By.CSS_SELECTOR, verificadores_login):
            print('Login detectado')
        else:
            raise AssertionError("‚ùå Timeout: login n√£o detectado.")
        

@then('devo ver a userpage do WhatsApp Web')
def verify_login(context):

    verificadores_login = 'div[aria-label="Lista de conversas"][role="grid"]'

    timeout_total = 180
    inicio = time.time()


    while time.time() - inicio< timeout_total:
        if context.driver.find_element(By.CSS_SELECTOR, verificadores_login):
            print('Login detectado')
        else:
            raise AssertionError("‚ùå Timeout: login n√£o detectado.")
    # Encerra o navegador ao final do teste
    context.driver.quit()
